# Описание GitLab CI/CD пайплайна для деплоя

## Общее назначение
Этот GitLab CI/CD пайплайн предназначен для автоматического развертывания (деплоя) кода на тестовые и продакшен-серверы linux websoft hcm в зависимости от ветки, в которую производится коммит.

## Основные компоненты

### Стадии (Stages)
- **deploy** - единственная стадия, отвечающая за развертывание приложения

### Переменные (Variables)
- `DEPLOY_PATH_TEST_SERVER` - путь к директории на тестовом сервере
- `DEPLOY_PATH_PROD_SERVER` - путь к директории на продакшен-сервере  
- `REPOSITORY_URL` - URL Git-репозитория (вынесен в переменную для удобства)

## Как работает пайплайн

### 1. Определение целевого сервера
Скрипт автоматически определяет, куда деплоить, на основе ветки:
- **Ветка `test`** → деплой на тестовый сервер
- **Ветка `prod`** → деплой на продакшен-сервер

### 2. Процесс деплоя
1. **Клонирование/обновление репозитория**
   - Если папка `.git` отсутствует - клонирует репозиторий
   - Если существует - обновляет код из нужной ветки

2. **Копирование файлов**
   - Используется `rsync` для эффективного копирования
   - Исключаются ненужные файлы (`.git`, `.yml`, `.md`)
   - Сохраняются права доступа и владельцы

### 3. Две отдельные задачи
- **deploy_test** - срабатывает при коммитах в ветку `test`
- **deploy_prod** - срабатывает при коммитах в ветку `prod`

## Особенности реализации

### Безопасность
- Используется `CI_JOB_TOKEN` для безопасного доступа к репозиторию
- Раздельные теги (`test`/`prod`) гарантируют выполнение на правильных раннерах

### Эффективность  
- Шаблон (`deploy_template`) исключает дублирование кода
- `rsync` копирует только измененные файлы
- Четкое разделение сред (test/prod)

### Гибкость
- Легко изменить пути деплоя через переменные
- Просто добавить новые среды при необходимости

## Процесс использования
1. Разработчик пушит в ветку `test` → автоматический деплой на тестовый сервер
2. После тестирования пушит в ветку `prod` → автоматический деплой на продакшен

Это обеспечивает непрерывную доставку с четким разделением сред разработки.
